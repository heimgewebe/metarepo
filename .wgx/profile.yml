---
class: meta

tasks:
  smoke: |
    echo "Running workflow validation..."
    # Use yq for robust YAML check
    for f in .github/workflows/*.yml; do
      [ -e "$f" ] || continue
      if ! kind=$(yq eval 'kind' "$f" 2>/dev/null); then
         echo "FAIL $f (invalid YAML)"
         exit 1
      fi
      if [[ "$kind" != "map" && "$kind" != "!!map" ]]; then
         echo "FAIL $f (root is not a map, got $kind)"
         exit 1
      fi
      echo "OK   $f"
    done
    echo "All workflows valid."

  guard: |
    echo "Running meta-guard checks..."

    # decision.preimage visibility guard (warn-only)
    # - checks for policy.decision JSON objects missing preimage_ref
    # - does NOT fail the build (yet)
    if [ -x "wgx/guards/decision-preimage.bash" ]; then
      echo "Running decision-preimage guard (warn-only)..."
      ./wgx/guards/decision-preimage.bash || true
    else
      echo "decision-preimage guard not found; skipping."
    fi

    # Integrity guard (blocking)
    if [ -x "wgx/guards/integrity.bash" ]; then
      echo "Running integrity guard..."
      ./wgx/guards/integrity.bash || exit 1
    else
      echo "FAIL: Integrity guard missing"
      exit 1
    fi

    if command -v shellcheck >/dev/null 2>&1; then
      echo "Running shellcheck on wgx/**/*.bash..."
      # bewusst fokussiert auf WGX-Bash-Module; bei Bedarf erweiterbar
      shellcheck -s bash wgx/**/*.bash || exit 1
    else
      echo "shellcheck not found; skipping shell lint."
    fi

    if command -v yamllint >/dev/null 2>&1; then
      echo "Running yamllint..."
      yamllint . || exit 1
    else
      echo "yamllint not found; skipping YAML lint."
    fi

    echo "Guard OK."

  metrics: |
    if [ -x scripts/wgx-metrics-snapshot.sh ]; then
      scripts/wgx-metrics-snapshot.sh --json
    else
      echo "No metrics script for metarepo, skipping."
    fi

  snapshot: |
    # no snapshot command defined
