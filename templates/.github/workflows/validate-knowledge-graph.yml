---
name: validate-knowledge-graph

"on":
  push:
    paths:
      - "knowledge.graph.json"
      - "docs/**/knowledge.graph.json"
      - ".github/workflows/validate-knowledge-graph.yml"
  pull_request:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a242bde00fd19c0e54fb3760beea110ee  # v4.1.0

      - name: Setup Node
        uses: actions/setup-node@5e221d4786ffb21088b21dfc9c80efb16b52cd3b  # v4.0.2

      - name: Install ajv-cli
        if: ${{ env.AGENT_MODE == '' }}
        run: npm i -g ajv-cli@5.0.0
      
      - name: Check ajv-cli (Agent-Mode)
        if: ${{ env.AGENT_MODE != '' }}
        run: |
          echo "Agent-Mode: skipping npm install, checking ajv-cli"
          command -v ajv >/dev/null 2>&1 || { echo "::error::ajv-cli not available in Agent-Mode"; exit 1; }

      - name: Validate knowledge.graph.json
        shell: bash
        env:
          SCHEMA_URL: >-
            https://raw.githubusercontent.com/heimgewebe/metarepo/contracts-v1/contracts/knowledge.graph.schema.json
        run: |
          set -euo pipefail
          shopt -s nullglob
          declare -a FILES=(
            knowledge.graph.json
          )
          # zusätzliche Standardpfade
          while IFS= read -r -d '' f; do
            FILES+=("$f")
          done < <(find docs -type f -name 'knowledge.graph.json' -print0 2>/dev/null || true)
          if (( ${#FILES[@]} == 0 )); then
            echo "::notice::Keine knowledge.graph.json gefunden – übersprungen."
            exit 0
          fi
          echo "Prüfe ${#FILES[@]} Datei(en)…"
          
          # Agent-Mode: use local schema if available
          if [[ "${AGENT_MODE:-}" != "" ]]; then
            echo "Agent-Mode: using local schema instead of downloading"
            if [ -f contracts/knowledge.graph.schema.json ]; then
              cp contracts/knowledge.graph.schema.json /tmp/schema.json
            else
              echo "::warning::Local schema not found in Agent-Mode, skipping validation"
              exit 0
            fi
          else
            curl -fsSL "$SCHEMA_URL" -o /tmp/schema.json
          fi
          
          for f in "${FILES[@]}"; do
            echo "→ $f"
            ajv validate --spec=draft2020 --strict=true --validate-formats=true -s /tmp/schema.json -d "$f"
          done
          echo "OK."
