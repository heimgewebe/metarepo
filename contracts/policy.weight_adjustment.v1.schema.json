{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://heimgewebe/contracts/policy.weight_adjustment.v1.schema.json",
  "title": "Policy Weight Adjustment v1",
  "description": "Canonical payload for policy weight adjustments. This is a payload schema, NOT an event envelope. It structures how weights should change based on feedback.",
  "type": "object",
  "x-producers": ["heimlern"],
  "x-consumers": ["hausKI"],
  "properties": {
    "deltas": {
      "type": "object",
      "description": "Map of weight keys to Delta objects.",
      "minProperties": 1,
      "propertyNames": {
        "pattern": "^[a-zA-Z0-9_.-]+$",
        "description": "Keys must be valid identifiers (alphanumeric, dot, underscore, dash)."
      },
      "additionalProperties": {
        "oneOf": [
          {
            "description": "Absolute adjustment.",
            "type": "object",
            "properties": {
              "kind": { "const": "absolute" },
              "value": { "type": "number", "description": "New absolute value." },
              "unit": { "type": "string" }
            },
            "required": ["kind", "value"],
            "additionalProperties": false
          },
          {
            "description": "Relative adjustment.",
            "type": "object",
            "properties": {
              "kind": { "const": "relative" },
              "value": { "type": "number", "minimum": -5.0, "maximum": 5.0, "description": "Relative multiplier or percentage change." },
              "unit": { "type": "string", "description": "Unit required for relative changes to clarify semantics (e.g., 'percent', 'factor')." }
            },
            "required": ["kind", "value", "unit"],
            "additionalProperties": false
          }
        ]
      }
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence score for this adjustment."
    },
    "decisions_analyzed": {
      "type": "integer",
      "minimum": 1,
      "description": "Number of decisions that contributed to this adjustment."
    },
    "status": {
      "type": "string",
      "enum": ["proposed", "accepted", "rejected", "superseded"],
      "description": "Status of this adjustment proposal."
    },
    "reasoning": {
      "type": "string",
      "minLength": 1,
      "description": "Explanation for the adjustment. Required if status is not 'proposed'."
    },
    "evidence": {
      "type": "object",
      "description": "Evidence or simulation results backing this adjustment.",
      "properties": {
        "failure_rate_after_sim": {
          "type": "number",
          "description": "Projected failure rate after applying the adjustment."
        },
        "simulation_method": {
          "type": "string",
          "description": "The method used for simulation. Required if failure_rate_after_sim is present."
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": { "required": ["failure_rate_after_sim"] },
          "then": { "required": ["simulation_method"] }
        },
        {
          "if": { "required": ["simulation_method"] },
          "then": { "required": ["failure_rate_after_sim"] }
        }
      ]
    }
  },
  "required": ["deltas"],
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": { "status": { "enum": ["accepted", "rejected", "superseded"] } },
        "required": ["status"]
      },
      "then": { "required": ["reasoning"] }
    }
  ]
}
