# Dieser Reusable wird von wgx-guard aufgerufen; keine Duplikate in wgx.
name: validate-observatory
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      STRICT:
        description: "Enforce strict schema validation (fail on errors)"
        required: false
        type: boolean
        default: false
      FAIL_ON_EMPTY:
        description: "Fail if no relevant files are found"
        required: false
        type: boolean
        default: false
  workflow_dispatch:
  push:
    paths:
      - "**/insights.daily.json"
      - "**/knowledge.observatory.json"
      - "**/insights.daily.published.json"
      - ".github/workflows/reusable-validate-observatory.yml"
    branches: [main]
  pull_request:
    paths:
      - "**/insights.daily.json"
      - "**/knowledge.observatory.json"
      - "**/insights.daily.published.json"
      - ".github/workflows/reusable-validate-observatory.yml"

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6

      - name: Install ajv-cli
        if: ${{ env.AGENT_MODE == '' }}
        run: npm i -g ajv-cli@5.0.0 ajv-formats

      - name: Check ajv-cli (Agent-Mode)
        if: ${{ env.AGENT_MODE != '' }}
        run: |
          echo "Agent-Mode: skipping npm install, checking ajv-cli"
          command -v ajv >/dev/null 2>&1 || { echo "::error::ajv-cli not available in Agent-Mode"; exit 1; }

      # ------------------------------------------------------------------
      # Validate insights.daily.json
      # ------------------------------------------------------------------
      - name: Validate insights.daily.json
        shell: bash
        env:
          FAIL_ON_EMPTY: ${{ inputs.FAIL_ON_EMPTY }}
          STRICT_MODE: ${{ inputs.STRICT }}
          SCHEMA_URL: >-
            https://raw.githubusercontent.com/heimgewebe/metarepo/main/contracts/insights.daily.schema.json
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          declare -a FILES=(
            **/insights.daily.json
          )

          if (( ${#FILES[@]} == 0 )); then
            if [[ "$FAIL_ON_EMPTY" == "true" ]]; then
               echo "::error::Keine insights.daily.json gefunden, aber FAIL_ON_EMPTY=true."
               exit 1
            else
               echo "::notice::Keine insights.daily.json gefunden."
            fi
          else
            echo "Prüfe ${#FILES[@]} insights.daily.json Datei(en)…"

            if [[ "${AGENT_MODE:-}" != "" ]]; then
              if [ -f contracts/insights.daily.schema.json ]; then
                cp contracts/insights.daily.schema.json /tmp/insights.schema.json
              else
                echo "::warning::Local schema not found in Agent-Mode, skipping validation"
                exit 0
              fi
            else
              curl -fsSL "$SCHEMA_URL" -o /tmp/insights.schema.json
            fi

            # Determine AJV flags
            AJV_FLAGS=(--spec=draft2020 -c ajv-formats)
            if [[ "$STRICT_MODE" == "true" ]]; then
               AJV_FLAGS+=(--strict=true)
            else
               AJV_FLAGS+=(--strict=log)
            fi

            for f in "${FILES[@]}"; do
              if [[ "$f" == *"node_modules"* || "$f" == *".git"* ]]; then continue; fi
              echo "→ $f"
              ajv validate "${AJV_FLAGS[@]}" -s /tmp/insights.schema.json -d "$f"
            done
          fi

      # ------------------------------------------------------------------
      # Validate knowledge.observatory.json
      # ------------------------------------------------------------------
      - name: Validate knowledge.observatory.json
        shell: bash
        env:
          FAIL_ON_EMPTY: ${{ inputs.FAIL_ON_EMPTY }}
          STRICT_MODE: ${{ inputs.STRICT }}
          SCHEMA_URL: >-
            https://raw.githubusercontent.com/heimgewebe/metarepo/main/contracts/knowledge.observatory.schema.json
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          declare -a FILES=(
            **/knowledge.observatory.json
          )

          if (( ${#FILES[@]} == 0 )); then
            if [[ "$FAIL_ON_EMPTY" == "true" ]]; then
               echo "::error::Keine knowledge.observatory.json gefunden, aber FAIL_ON_EMPTY=true."
               exit 1
            else
               echo "::notice::Keine knowledge.observatory.json gefunden."
            fi
          else
            echo "Prüfe ${#FILES[@]} knowledge.observatory.json Datei(en)…"

            if [[ "${AGENT_MODE:-}" != "" ]]; then
              if [ -f contracts/knowledge.observatory.schema.json ]; then
                cp contracts/knowledge.observatory.schema.json /tmp/observatory.schema.json
              else
                echo "::warning::Local schema not found in Agent-Mode, skipping validation"
                exit 0
              fi
            else
              curl -fsSL "$SCHEMA_URL" -o /tmp/observatory.schema.json
            fi

            AJV_FLAGS=(--spec=draft2020 -c ajv-formats)
            if [[ "$STRICT_MODE" == "true" ]]; then
               AJV_FLAGS+=(--strict=true)
            else
               AJV_FLAGS+=(--strict=log)
            fi

            for f in "${FILES[@]}"; do
              if [[ "$f" == *"node_modules"* || "$f" == *".git"* ]]; then continue; fi
              echo "→ $f"
              ajv validate "${AJV_FLAGS[@]}" -s /tmp/observatory.schema.json -d "$f"
            done
          fi

      # ------------------------------------------------------------------
      # Validate insights.daily.published.json (Events)
      # ------------------------------------------------------------------
      - name: Validate insights.daily.published.json
        shell: bash
        env:
          FAIL_ON_EMPTY: ${{ inputs.FAIL_ON_EMPTY }}
          STRICT_MODE: ${{ inputs.STRICT }}
          # Canonical URL for the event schema
          SCHEMA_URL: >-
            https://raw.githubusercontent.com/heimgewebe/metarepo/main/contracts/events/insights.daily.published.v1.schema.json
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          declare -a FILES=(
            **/insights.daily.published.json
            **/insights.daily.published.v1.json
          )

          if (( ${#FILES[@]} == 0 )); then
            # No error here even if FAIL_ON_EMPTY is true?
            # The prompt implies published events are crucial, but maybe not present in every run.
            # However, if FAIL_ON_EMPTY is requested, we should probably honor it or handle it specifically.
            # Given instructions: "Guard 2: insights.daily.published.v1 muss schema-valid sein"
            # I will apply FAIL_ON_EMPTY logic here too if set.
            if [[ "$FAIL_ON_EMPTY" == "true" ]]; then
               echo "::notice::Keine insights.daily.published.json gefunden (FAIL_ON_EMPTY active)."
               # Not strictly failing here unless we want to force publication existence?
               # The user says: "Trigger explizit: insights.daily -> insights.daily.published.v1"
               # If the caller sets FAIL_ON_EMPTY, they likely expect files.
               echo "::error::Keine insights.daily.published.json gefunden."
               exit 1
            else
               echo "::notice::Keine insights.daily.published.json gefunden."
            fi
          else
            echo "Prüfe ${#FILES[@]} insights.daily.published.json Datei(en)…"

            if [[ "${AGENT_MODE:-}" != "" ]]; then
              if [ -f contracts/events/insights.daily.published.v1.schema.json ]; then
                cp contracts/events/insights.daily.published.v1.schema.json /tmp/published.schema.json
              else
                echo "::warning::Local schema not found in Agent-Mode, skipping validation"
                exit 0
              fi
            else
              curl -fsSL "$SCHEMA_URL" -o /tmp/published.schema.json
            fi

            AJV_FLAGS=(--spec=draft2020 -c ajv-formats)
            if [[ "$STRICT_MODE" == "true" ]]; then
               AJV_FLAGS+=(--strict=true)
            else
               AJV_FLAGS+=(--strict=log)
            fi

            for f in "${FILES[@]}"; do
              if [[ "$f" == *"node_modules"* || "$f" == *".git"* ]]; then continue; fi
              echo "→ $f"
              ajv validate "${AJV_FLAGS[@]}" -s /tmp/published.schema.json -d "$f"
            done
          fi
