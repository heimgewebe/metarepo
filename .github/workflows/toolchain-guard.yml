name: toolchain-guard
permissions:
  contents: read

on:
  push:

jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq (robust)
        shell: bash
        run: |
          set -euo pipefail

          YQ_VERSION="v4.44.3"
          BIN_DIR="${GITHUB_WORKSPACE}/tools/bin"
          mkdir -p "${BIN_DIR}"

          # Für aktuelle und nachfolgende Steps
          echo "${BIN_DIR}" >> "${GITHUB_PATH}"
          export PATH="${BIN_DIR}:${PATH}"

          TMP_BIN="$(mktemp "${BIN_DIR}/yq.dl.XXXXXX")"
          TMP_SHA="$(mktemp "${BIN_DIR}/yq.sha256.XXXXXX")"

          echo "Lade yq ${YQ_VERSION} herunter..."
          curl --fail --max-time 60 --connect-timeout 10 --retry 3 -fsSL \
            "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" \
            -o "${TMP_BIN}"

          echo "Lade Checksums-Datei..."
          if ! curl --fail --max-time 60 --connect-timeout 10 --retry 3 -fsSL \
              "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/checksums" \
              -o "${TMP_SHA}"; then
            if ! curl --fail --max-time 60 --connect-timeout 10 --retry 3 -fsSL \
                "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/checksums.txt" \
                -o "${TMP_SHA}"; then
              echo "::warning::Konnte keine Checksums-Datei herunterladen – überspringe Verifikation."
              mv "${TMP_BIN}" "${BIN_DIR}/yq"
              chmod +x "${BIN_DIR}/yq"
              "${BIN_DIR}/yq" --version || {
                echo "::error::yq installiert, aber --version schlägt fehl."
                exit 1
              }
              exit 0
            fi
          fi

          if [[ ! -s "${TMP_SHA}" ]]; then
            echo "::warning::Checksums-Datei ist leer – überspringe Verifikation."
            mv "${TMP_BIN}" "${BIN_DIR}/yq"
            chmod +x "${BIN_DIR}/yq"
            "${BIN_DIR}/yq" --version || {
              echo "::error::yq installiert, aber --version schlägt fehl."
              exit 1
            }
            exit 0
          fi

          # Berechne den SHA256-Hash der heruntergeladenen Datei
          ACTUAL_SUM="$(sha256sum "${TMP_BIN}" | awk '{print $1}')"

          # Suche nach einer Zeile, die sowohl den Hash als auch den Dateinamen enthält
          if grep -q "${ACTUAL_SUM}.*yq_linux_amd64" "${TMP_SHA}"; then
            echo "Checksumme verifiziert: ${ACTUAL_SUM}"
          else
            echo "::error::Checksum-Verifikation fehlgeschlagen! Kein passender Eintrag für Hash ${ACTUAL_SUM} und Datei yq_linux_amd64 gefunden."
            exit 1
          fi

          mv "${TMP_BIN}" "${BIN_DIR}/yq"
          chmod +x "${BIN_DIR}/yq"

          echo "Prüfe yq-Version..."
          "${BIN_DIR}/yq" --version

      # weitere Guard-Schritte können hier folgen, z. B.:
      # - name: Run toolchain guard
      #   run: |
      #     ./scripts/toolchain-guard.sh