---
name: toolchain-guard
permissions:
  contents: read
'on':
  push:
jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Check yq availability (Agent-Mode)
        if: ${{ env.AGENT_MODE != '' }}
        run: |
          echo "Agent-Mode: skipping yq download, checking if pre-installed"
          if command -v yq >/dev/null 2>&1; then
            echo "yq found: $(yq --version)"
          else
            echo "::error::yq not available in Agent-Mode. Please pre-install it."
            exit 1
          fi

      - name: Install yq (robust)
        if: ${{ env.AGENT_MODE == '' }}
        run: |
          set -euo pipefail

          # Use version from toolchain.versions.yml if available, otherwise fallback
          if [[ -f toolchain.versions.yml ]]; then
            YQ_VERSION=$(grep -E '^\s*yq:' toolchain.versions.yml | \
              sed -E 's/^\s*[^:]+:\s*//; s/#.*$//; s/^[[:space:]]*//; s/[[:space:]]*$//; s/^"//; s/"$//; s/^'\''//; s/'\''$//' | \
              tr -d '\n\r')
          fi
          YQ_VERSION="${YQ_VERSION:-v4.50.1}"

          os="$(uname -s | tr '[:upper:]' '[:lower:]')"
          arch="$(uname -m)"
          case "$arch" in
            x86_64|amd64) arch="amd64" ;;
            aarch64|arm64) arch="arm64" ;;
            *) echo "Unsupported arch: $arch" >&2; exit 1 ;;
          esac

          asset="yq_${os}_${arch}"
          base="https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}"

          BIN_DIR="${GITHUB_WORKSPACE}/tools/bin"
          mkdir -p "$BIN_DIR"
          echo "$BIN_DIR" >> "$GITHUB_PATH"

          echo "Installing yq ${YQ_VERSION} for ${os}/${arch}..."

          # Direct download without metadata parsing
          curl -fsSL -o "${BIN_DIR}/yq" "${base}/${asset}"
          curl -fsSL -o "${BIN_DIR}/checksums" "${base}/checksums"

          # Extract SHA-256 hash for this specific asset
          # yq checksums file format: filename hash1 hash2 ... hash18(sha256) ...
          # SHA-256 is field 19 (1=filename + 18 hashes before SHA-256)
          cd "${BIN_DIR}"
          line=$(grep "^${asset}[[:space:]]" checksums)
          sha256=$(echo "$line" | awk '{print $19}')
          
          if [[ ! "$sha256" =~ ^[0-9a-fA-F]{64}$ ]]; then
            echo "ERROR: Could not extract valid SHA-256 hash for ${asset}" >&2
            echo "Line: ${line}" >&2
            exit 1
          fi

          # Verify checksum
          actual_sha256=$(sha256sum yq | awk '{print $1}')
          if [[ "$sha256" != "$actual_sha256" ]]; then
            echo "ERROR: Checksum mismatch!" >&2
            echo "Expected: $sha256" >&2
            echo "Actual:   $actual_sha256" >&2
            exit 1
          fi

          echo "âœ… Checksum verified: $sha256"
          chmod +x yq
          rm checksums

          # Verify installation
          ./yq --version
          echo "âœ… yq installed successfully"
      - name: Install just
        run: scripts/tools/just-pin.sh
      - name: Lint GitHub workflows (actionlint)
        uses: rhysd/actionlint@v1.7.9
        with:
          args: -color
      - name: Show tool versions
        run: |
          set +e
          command -v uv >/dev/null 2>&1 && uv --version
          command -v just >/dev/null 2>&1 && just --version
          command -v yq >/dev/null 2>&1 && yq --version
          command -v gh >/dev/null 2>&1 && gh --version
          command -v ruby >/dev/null 2>&1 && ruby --version
          set -e
