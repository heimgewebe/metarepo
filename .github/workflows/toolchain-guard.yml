name: toolchain-guard
permissions:
  contents: read
on:
  push:
jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - name: Install yq (robust)
        run: |
          set -euo pipefail
          YQ_VERSION="v4.49.2"
          YQ_ARCH="linux_amd64"
          BIN_DIR="${GITHUB_WORKSPACE}/tools/bin"
          mkdir -p "$BIN_DIR"
          # Add to PATH for subsequent steps in this job
          echo "$BIN_DIR" >> "$GITHUB_PATH"

          TMP_BIN="$(mktemp "$BIN_DIR/yq.dl.XXXXXX")"
          TMP_SHA="$(mktemp "$BIN_DIR/yq.sha.XXXXXX")"
          RELEASE_JSON="$(mktemp "$BIN_DIR/release.json.XXXXXX")"

          echo "Querying release assets for $YQ_VERSION..."
          if ! curl --fail --max-time 60 --connect-timeout 10 --retry 3 -fsSL \
              "https://api.github.com/repos/mikefarah/yq/releases/tags/${YQ_VERSION}" -o "$RELEASE_JSON"; then
            echo "Fehler: konnte Release metadata nicht laden" >&2
            rm -f "$RELEASE_JSON"
            exit 1
          fi

          ASSET_URLS="$({
            grep -oE '"browser_download_url":\s*"[^\"]+"' "$RELEASE_JSON" \
              | sed -E 's/.*"([^"]+)".*/\1/'
          } || true)"

          # Try deterministic candidate asset names first
          BIN_CANDIDATES=(
            "yq_linux_amd64"
            "yq_linux_x86_64"
            "yq_linux_amd64.tar.gz"
            "yq_linux_x86_64.tar.gz"
            "yq_linux_arm64"
            "yq_linux_arm64.tar.gz"
            "yq_linux_ppc64le"
          )

          BIN_URL=""
          for name in "${BIN_CANDIDATES[@]}"; do
            candidate="https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/${name}"
            if curl --head --silent --fail --max-time 10 "$candidate" >/dev/null 2>&1; then
              BIN_URL="$candidate"
              break
            fi
          done

          # Fallback to scanning release JSON assets (existing behavior)
          if [[ -z "$BIN_URL" ]]; then
            BIN_URL="$({
              printf '%s\n' "$ASSET_URLS" \
                | grep -Ei "yq.*(${YQ_ARCH}|linux.*amd64|amd64|x86_64|linux|yq_linux)" \
                | head -n1
            } || true)"
          fi

          if [[ -z "$BIN_URL" ]]; then
            echo "Fehler: konnte keine passende yq-Binary-URL in Release-Assets finden" >&2
            echo "Release asset list (debug):" >&2
            printf '%s\n' "$ASSET_URLS" >&2
            rm -f "$RELEASE_JSON"
            exit 1
          fi

          echo "Download binary from: $BIN_URL"
          curl --fail --max-time 120 --connect-timeout 10 --retry 3 -fsSL "$BIN_URL" -o "$TMP_BIN"

          # Try a list of likely checksum filenames hosted under the release /download/{tag}/
          SHA_CANDIDATES=(
            "checksums.txt"
            "checksums"
            "SHA256SUMS.txt"
            "sha256sum.txt"
            "sha256sums.txt"
            "sha256sums"
            "yq_${YQ_VERSION}_SHA256SUMS.txt"
          )

          for s in "${SHA_CANDIDATES[@]}"; do
            sha_candidate="https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/${s}"
            TMP_SHA_TMP="${TMP_SHA}.tmp"
            rm -f "$TMP_SHA_TMP"
            if curl --fail --max-time 60 --connect-timeout 10 --retry 2 -fsSL "$sha_candidate" -o "$TMP_SHA_TMP"; then
              if [[ -s "$TMP_SHA_TMP" ]]; then
                mv "$TMP_SHA_TMP" "$TMP_SHA"
                break
              fi
            fi
            rm -f "$TMP_SHA_TMP"
          done

          # Fallback: try to find a checksum asset URL inside the release JSON (existing behavior)
          if [[ ! -s "$TMP_SHA" ]]; then
            SHA_URL="$({
              printf '%s\n' "$ASSET_URLS" \
                | grep -Ei 'checksums.*\.txt$|checksums$|sha256|sha256sum|SHA256' \
                | head -n1
            } || true)"
            if [[ -n "$SHA_URL" ]]; then
              echo "Download checksum from: $SHA_URL"
              if curl --fail --max-time 120 --connect-timeout 10 --retry 3 -fsSL "$SHA_URL" -o "$TMP_SHA"; then
                [[ -s "$TMP_SHA" ]] || { rm -f "$TMP_SHA"; }
              else
                rm -f "$TMP_SHA"
              fi
            fi
          fi

          rm -f "$RELEASE_JSON"

          if [[ ! -s "$TMP_SHA" ]]; then
            echo "Fehler: keine Checksums-Datei gefunden oder leer; Abbruch statt unsicherer Installation" >&2
            echo "Debug: available release assets:" >&2
            printf '%s\n' "$ASSET_URLS" >&2
            echo "If this release intentionally lacks checksums you can either pick a different YQ_VERSION or add a known-good checksum to the workflow." >&2
            exit 1
          fi

          # Calculate and verify
          ACTUAL_SHA="$(sha256sum "$TMP_BIN" | awk '{print $1}')"
          ASSET_NAME="$(basename "$BIN_URL")"
          EXPECTED_SHA="$(
            grep -iF "$ASSET_NAME" "$TMP_SHA" \
              | grep -oE '[0-9a-fA-F]{64}' \
              | head -n1 || true
          )"
          if [[ -z "$EXPECTED_SHA" ]]; then
            EXPECTED_SHA="$(grep -oE '[0-9a-fA-F]{64}' "$TMP_SHA" | head -n1 || true)"
          fi

          if [[ -n "$EXPECTED_SHA" && "$EXPECTED_SHA" == "$ACTUAL_SHA" ]]; then
            echo "SHA256-Prüfsumme erfolgreich verifiziert: $ACTUAL_SHA"
          else
            echo "SHA256-Prüfsumme stimmt nicht überein!" >&2
            echo "Binary: $BIN_URL" >&2
            echo "Gesuchter Hash: $ACTUAL_SHA" >&2
            echo "Gefundener Hash in Checksums-Datei: ${EXPECTED_SHA:-'(kein Hash gefunden)'}" >&2
            sed -n '1,200p' "$TMP_SHA" >&2 || true
            exit 1
          fi

          chmod +x "$TMP_BIN"
          mv "$TMP_BIN" "$BIN_DIR/yq"
          echo "yq erfolgreich installiert und verifiziert."
      - name: Install just
        run: scripts/tools/just-pin.sh
      - name: Lint GitHub workflows (actionlint)
        uses: rhysd/actionlint@v1.7.9
        with:
          args: -color
      - name: Show tool versions
        run: |
          set +e
          command -v uv >/dev/null 2>&1 && uv --version
          command -v just >/dev/null 2>&1 && just --version
          command -v yq >/dev/null 2>&1 && yq --version
          command -v gh >/dev/null 2>&1 && gh --version
          command -v ruby >/dev/null 2>&1 && ruby --version
          set -e
