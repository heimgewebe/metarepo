name: toolchain-guard
permissions:
  contents: read
on:
  push:
jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - name: Install yq (robust)
        run: |
          set -euo pipefail
          YQ_VERSION="v4.44.3"
          YQ_ARCH="linux_amd64"
          BIN_DIR="${GITHUB_WORKSPACE}/tools/bin"
          mkdir -p "$BIN_DIR"
          # Add to PATH for subsequent steps in this job
          echo "$BIN_DIR" >> "$GITHUB_PATH"

          TMP_BIN="$(mktemp "$BIN_DIR/yq.dl.XXXXXX")"
          TMP_SHA="$(mktemp "$BIN_DIR/yq.sha.XXXXXX")"
          RELEASE_JSON="$(mktemp "$BIN_DIR/release.json.XXXXXX")"

          echo "Querying release assets for $YQ_VERSION..."
          if ! curl --fail --max-time 60 --connect-timeout 10 --retry 3 -fsSL \
              "https://api.github.com/repos/mikefarah/yq/releases/tags/${YQ_VERSION}" -o "$RELEASE_JSON"; then
            echo "Fehler: konnte Release metadata nicht laden" >&2
            rm -f "$RELEASE_JSON"
            exit 1
          fi

          # Find the binary asset URL that best matches the desired arch
          BIN_URL="$(
            grep -oE '"browser_download_url":\s*"[^\"]+"' "$RELEASE_JSON" \
              | sed -E 's/.*"([^"]+)".*/\1/' \
              | grep -Ei "yq.*(${YQ_ARCH}|linux.*amd64|amd64|x86_64)" \
              | head -n1 || true
          )"

          # Fallback: any yq_linux* binary
          if [[ -z "$BIN_URL" ]]; then
            BIN_URL="$(
              grep -oE '"browser_download_url":\s*"[^\"]+"' "$RELEASE_JSON" \
                | sed -E 's/.*"([^"]+)".*/\1/' \
                | grep -Ei "yq(_|-)linux|yq.*linux" \
                | head -n1 || true
            )"
          fi

          if [[ -z "$BIN_URL" ]]; then
            echo "Fehler: konnte keine passende yq-Binary-URL in Release-Assets finden" >&2
            sed -n '1,200p' "$RELEASE_JSON" >&2 || true
            rm -f "$RELEASE_JSON"
            exit 1
          fi

          echo "Download binary from: $BIN_URL"
          curl --fail --max-time 120 --connect-timeout 10 --retry 3 -fsSL "$BIN_URL" -o "$TMP_BIN"

          # Find checksum asset: prefer dedicated checksums files first
          SHA_URL="$(
            grep -oE '"browser_download_url":\s*"[^\"]+"' "$RELEASE_JSON" \
              | sed -E 's/.*"([^"]+)".*/\1/' \
              | grep -Ei 'checksums(\.txt)?$' \
              | head -n1 || true
          )"

          # Fallback: any asset that looks like a checksum listing
          if [[ -z "$SHA_URL" ]]; then
            SHA_URL="$(
              grep -oE '"browser_download_url":\s*"[^\"]+"' "$RELEASE_JSON" \
                | sed -E 's/.*"([^"]+)".*/\1/' \
                | grep -Ei "sha|check|checksum|SHA256|sha256" \
                | head -n1 || true
            )"
          fi

          rm -f "$RELEASE_JSON"

          if [[ -n "$SHA_URL" ]]; then
            echo "Download checksum from: $SHA_URL"
            if curl --fail --max-time 120 --connect-timeout 10 --retry 3 -fsSL "$SHA_URL" -o "$TMP_SHA"; then
              if [[ ! -s "$TMP_SHA" ]]; then
                echo "Gefundene Checksums-Datei ist leer" >&2
                rm -f "$TMP_SHA"
              fi
            else
              echo "Warnung: konnte Checksums-Datei nicht herunterladen; Installation wird abgebrochen" >&2
              rm -f "$TMP_SHA"
            fi
          fi

          if [[ ! -s "$TMP_SHA" ]]; then
            echo "Fehler: keine Checksums-Datei gefunden oder leer; Abbruch statt unsicherer Installation" >&2
            exit 1
          fi

          # Calculate actual sha
          ACTUAL_SHA="$(sha256sum "$TMP_BIN" | awk '{print $1}')"

          # Try find expected sha from checksums file
          # Prefer a line that mentions the asset filename
          ASSET_NAME="$(basename "$BIN_URL")"
          EXPECTED_SHA="$(
            grep -i "$ASSET_NAME" "$TMP_SHA" \
              | grep -oE '[0-9a-fA-F]{64}' \
              | head -n1 || true
          )"
          if [[ -z "$EXPECTED_SHA" ]]; then
            EXPECTED_SHA="$(grep -oE '[0-9a-fA-F]{64}' "$TMP_SHA" | head -n1 || true)"
          fi

          if [[ -n "$EXPECTED_SHA" && "$EXPECTED_SHA" == "$ACTUAL_SHA" ]]; then
            echo "SHA256-Prüfsumme erfolgreich verifiziert: $ACTUAL_SHA"
          else
            echo "SHA256-Prüfsumme stimmt nicht überein!" >&2
            echo "Binary: $BIN_URL" >&2
            echo "Gesuchter Hash: $ACTUAL_SHA" >&2
            echo "Gefundener Hash in Checksums-Datei: ${EXPECTED_SHA:-'(kein Hash gefunden)'}" >&2
            sed -n '1,200p' "$TMP_SHA" >&2 || true
            exit 1
          fi

          chmod +x "$TMP_BIN"
          mv "$TMP_BIN" "$BIN_DIR/yq"
          echo "yq erfolgreich installiert und verifiziert."
      - name: Install just
        run: scripts/tools/just-pin.sh
      - name: Lint GitHub workflows (actionlint)
        uses: rhysd/actionlint@v1.7.9
        with:
          args: -color
      - name: Show tool versions
        run: |
          set +e
          command -v uv >/dev/null 2>&1 && uv --version
          command -v just >/dev/null 2>&1 && just --version
          command -v yq >/dev/null 2>&1 && yq --version
          command -v gh >/dev/null 2>&1 && gh --version
          command -v ruby >/dev/null 2>&1 && ruby --version
          set -e
