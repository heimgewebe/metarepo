name: toolchain-guard
permissions:
  contents: read
'on':
  push:
    paths:
      - 'toolchain.versions.yml'
      - '.github/workflows/toolchain-guard.yml'
      - '.github/schemas/toolchain.versions.schema.json'
      - 'scripts/tools/validate-toolchain.sh'
  pull_request:
    paths:
      - 'toolchain.versions.yml'
      - '.github/workflows/toolchain-guard.yml'
      - '.github/schemas/toolchain.versions.schema.json'
      - 'scripts/tools/validate-toolchain.sh'
  workflow_dispatch:

jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node (for ajv-cli)
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Check yq availability (Agent-Mode)
        if: ${{ env.AGENT_MODE != '' }}
        run: |
          echo "Agent-Mode: skipping yq download, checking if pre-installed"
          if command -v yq >/dev/null 2>&1; then
            echo "yq found: $(yq --version)"
          else
            echo "::error::yq not available in Agent-Mode. Please pre-install it."
            exit 1
          fi

      - name: "Toolchain: setup yq (deterministic)"
        if: ${{ env.AGENT_MODE == '' }}
        shell: bash
        env:
          ALLOW_NET: 1
        run: |
          set -euo pipefail
          test -x scripts/tools/yq-pin.sh || { echo "::error::missing scripts/tools/yq-pin.sh"; ls -la scripts/tools || true; exit 1; }
          scripts/tools/yq-pin.sh ensure

          # IMPORTANT: GITHUB_PATH affects next steps only; export for this step too
          export PATH="${{ github.workspace }}/tools/bin:$PATH"
          echo "${{ github.workspace }}/tools/bin" >> "$GITHUB_PATH"

      - name: "Assert: yq available"
        shell: bash
        run: |
          set -euo pipefail
          export PATH="${{ github.workspace }}/tools/bin:$PATH"

          command -v yq || { echo "::error::yq still missing after setup"; exit 1; }
          yq --version || { echo "::error::yq not executable"; exit 1; }
          yq --version | grep -q "version v4" || { echo "::error::wrong yq version"; exit 1; }
          echo "âœ… yq verified"

      - name: Validate Toolchain
        run: |
          chmod +x scripts/tools/validate-toolchain.sh
          scripts/tools/validate-toolchain.sh

      - name: Install just
        run: scripts/tools/just-pin.sh

      - name: Lint GitHub workflows (actionlint)
        uses: rhysd/actionlint@v1.7.11
        with:
          args: -color

      - name: Show tool versions
        run: |
          set +e
          command -v uv >/dev/null 2>&1 && uv --version
          command -v just >/dev/null 2>&1 && just --version
          command -v yq >/dev/null 2>&1 && yq --version
          command -v gh >/dev/null 2>&1 && gh --version
          command -v ruby >/dev/null 2>&1 && ruby --version
          set -e
