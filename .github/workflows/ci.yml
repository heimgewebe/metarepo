      - name: Read toolchain versions
        run: |
          set -euo pipefail

          # Ensure tools/bin is used in THIS step (GITHUB_PATH affects subsequent steps only)
          export PATH="${{ github.workspace }}/tools/bin:$PATH"
          echo "${{ github.workspace }}/tools/bin" >> "$GITHUB_PATH"

          TOOLCHAIN_FILE="${GITHUB_WORKSPACE}/toolchain.versions.yml"
          test -f "$TOOLCHAIN_FILE" || { echo "::error::toolchain.versions.yml not found at $TOOLCHAIN_FILE"; exit 1; }

          # Verify yq exists and is mikefarah/yq v4
          command -v yq >/dev/null || { echo "::error::yq missing in PATH"; exit 1; }
          YQ_VER="$(yq --version || true)"
          echo "$YQ_VER" | grep -q "version v4" || { echo "::error::yq is not mikefarah/yq v4 (got: $YQ_VER)"; exit 1; }

          # Verify the YAML parses before converting
          yq eval '.' "$TOOLCHAIN_FILE" >/dev/null 2>&1 || { echo "::error::yq failed to parse toolchain.versions.yml (syntax?)"; exit 1; }

          # Convert YAML -> JSON once, then read everything via jq
          TOOLCHAIN_JSON="$(mktemp)"
          trap 'rm -f "$TOOLCHAIN_JSON"' EXIT
          yq eval -o=json '.' "$TOOLCHAIN_FILE" > "$TOOLCHAIN_JSON"

          require_key() {
            local key="$1"
            local val
            val="$(jq -r --arg k "$key" '.[$k]' "$TOOLCHAIN_JSON")"
            if [ -z "$val" ] || [ "$val" = "null" ]; then
              echo "::error::${key} version missing in toolchain.versions.yml"
              exit 1
            fi
            echo "$val"
          }

          RUST="$(require_key rust)"
          PYTHON="$(require_key python)"
          UV="$(require_key uv)"
          JUST="$(require_key just)"
          SCCACHE="$(require_key sccache)"
          ACTIONLINT="$(require_key actionlint)"
          YQ_PIN="$(require_key yq)"

          echo "RUST_VERSION=$RUST" >> "$GITHUB_ENV"
          echo "PYTHON_VERSION=$PYTHON" >> "$GITHUB_ENV"
          echo "UV_VERSION=$UV" >> "$GITHUB_ENV"
          echo "JUST_VERSION=$JUST" >> "$GITHUB_ENV"
          echo "SCCACHE_VERSION=$SCCACHE" >> "$GITHUB_ENV"
          echo "ACTIONLINT_VERSION=$ACTIONLINT" >> "$GITHUB_ENV"
          echo "YQ_VERSION=$YQ_PIN" >> "$GITHUB_ENV"

          echo "Detected toolchain versions: Rust=$RUST, Python=$PYTHON, uv=$UV, just=$JUST, sccache=$SCCACHE, actionlint=$ACTIONLINT, yq=$YQ_PIN"