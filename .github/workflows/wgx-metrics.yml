---
name: wgx metrics (reusable)

permissions:
  contents: read
concurrency:
  group: wgx-metrics-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

"on":
  workflow_call:
    inputs:
      post_url:
        required: false
        type: string
      schema_ref:
        required: false
        type: string
        default: "contracts-v1"

jobs:
  metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install tooling
        run: |
          set -euo pipefail
          
          # Agent-Mode: skip installs
          if [[ "${AGENT_MODE:-}" != "" ]]; then
            echo "Agent-Mode: skipping apt-get and npm installs"
            command -v jq >/dev/null 2>&1 || { echo "::error::jq not available in Agent-Mode"; exit 1; }
            command -v ajv >/dev/null 2>&1 || { echo "::error::ajv-cli not available in Agent-Mode"; exit 1; }
          else
            sudo apt-get update
            sudo apt-get install -y jq curl || true
            npm i -g ajv-cli@5
          fi

      - name: Run wgx metrics snapshot
        env:
          OUTPUT_PATH: metrics.json
        run: |
          set -euo pipefail
          if [ -x scripts/wgx-metrics-snapshot.sh ]; then
            bash scripts/wgx-metrics-snapshot.sh > "$OUTPUT_PATH"
          elif command -v just >/dev/null 2>&1; then
            if just --list > /tmp/just-list 2>&1 && grep -q "wgx metrics snapshot" /tmp/just-list; then
              just wgx metrics snapshot --json > "$OUTPUT_PATH"
            fi
          fi
          if [ ! -s "$OUTPUT_PATH" ]; then
            if command -v wgx >/dev/null 2>&1; then
              wgx metrics snapshot --json > "$OUTPUT_PATH"
            else
              echo "::error::No wgx metrics snapshot command available"
              exit 1
            fi
          fi
          jq . "$OUTPUT_PATH"

      - name: Validate metrics payload
        env:
          SCHEMA_TAG: ${{ inputs.schema_ref }}
        run: |
          set -euo pipefail
          
          # Agent-Mode: use local schema
          if [[ "${AGENT_MODE:-}" != "" ]]; then
            echo "Agent-Mode: using local schema instead of downloading"
            if [ -f contracts/metrics.snapshot.schema.json ]; then
              cp contracts/metrics.snapshot.schema.json metrics.schema.json
            else
              echo "::warning::Local metrics schema not found in Agent-Mode, skipping validation"
              exit 0
            fi
          else
            SCHEMA_URL="https://raw.githubusercontent.com/heimgewebe/metarepo/${SCHEMA_TAG}/contracts/metrics.snapshot.schema.json"
            echo "Fetching schema from $SCHEMA_URL"
            curl -fsSL "$SCHEMA_URL" -o metrics.schema.json
          fi
          
          ajv validate -s metrics.schema.json -d metrics.json

      - name: Optional POST to ingest endpoint
        if: ${{ inputs.post_url != '' && env.AGENT_MODE == '' }}
        env:
          POST_URL: ${{ inputs.post_url }}
        run: |
          set -euo pipefail
          echo "POSTing metrics snapshot to $POST_URL"
          curl -fsS --data-binary @metrics.json "$POST_URL"
      
      - name: Skip POST to ingest (Agent-Mode)
        if: ${{ inputs.post_url != '' && env.AGENT_MODE != '' }}
        run: |
          echo "Agent-Mode: skipping external POST to ingest endpoint"
