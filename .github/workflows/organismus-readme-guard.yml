---
name: organismus-readme-guard

"on":
  pull_request:
    paths:
      - "README.md"
      - "docs/system/heimgewebe-organismus.md"
      - "docs/system/heimgewebe-zielbild.md"
      - "docs/heimgewebe-organismus.md"
      - "docs/heimgewebe-zielbild.md"
      - ".github/workflows/organismus-readme-guard.yml"
  push:
    branches:
      - main
      - master
    paths:
      - "README.md"
      - "docs/system/heimgewebe-organismus.md"
      - "docs/system/heimgewebe-zielbild.md"
      - "docs/heimgewebe-organismus.md"
      - "docs/heimgewebe-zielbild.md"
      - ".github/workflows/organismus-readme-guard.yml"

permissions:
  contents: read

jobs:
  check-readme-organismus-block:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Ensure README links to Heimgewebe-Organismus
        run: |
          set -euo pipefail

          if [[ ! -f "README.md" ]]; then
            echo "::warning file=README.md::README.md nicht gefunden – Organismus-Hinweis kann nicht geprüft werden."
            exit 0
          fi

          # Check for canonical path: must contain 'system/'
          if ! grep -Eqi '(^|[(/])docs/system/heimgewebe-organismus\.md([)#]|$)|github\.com/heimgewebe/metarepo/blob/main/docs/system/heimgewebe-organismus\.md' README.md; then
            echo "::error file=README.md::README.md muss auf den kanonischen Pfad docs/system/heimgewebe-organismus.md verweisen."
            echo "Veraltete Links auf Stubs (docs/heimgewebe-organismus.md) sind nicht zulässig."
            exit 1
          fi

          if ! grep -Eqi '(^|[(/])docs/system/heimgewebe-zielbild\.md([)#]|$)|github\.com/heimgewebe/metarepo/blob/main/docs/system/heimgewebe-zielbild\.md' README.md; then
            echo "::error file=README.md::README.md muss auf den kanonischen Pfad docs/system/heimgewebe-zielbild.md verweisen."
            echo "Veraltete Links auf Stubs (docs/heimgewebe-zielbild.md) sind nicht zulässig."
            exit 1
          fi

          echo "Organismus-Verweise im README vorhanden."
