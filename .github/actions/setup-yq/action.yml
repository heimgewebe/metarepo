---
name: 'Setup yq'
description: 'Install yq using version from toolchain.versions.yml and verify checksum'
inputs:
  github-token:
    description: 'GitHub token for API authentication (to avoid rate limits)'
    required: false
    default: ''
runs:
  using: 'composite'
  steps:
    - name: Load yq version pin
      shell: bash
      run: |
        if [[ ! -f toolchain.versions.yml ]]; then
          echo "toolchain.versions.yml not found in $(pwd)" >&2
          exit 1
        fi

        # Extract yq version using robust grep/sed to avoid python dependency
        # Handles: yq: "v4.49.2" # comment
        # Logic mirrors scripts/tools/just-pin.sh:
        # 1. Strip key
        # 2. Strip comments
        # 3. Trim whitespace
        # 4. Strip quotes
        YQ_VER=$(grep -E '^\s*yq:' toolchain.versions.yml | \
          sed -E 's/^\s*[^:]+:\s*//; s/#.*$//; s/^[[:space:]]*//; s/[[:space:]]*$//; s/^"//; s/"$//; s/^'\''//; s/'\''$//' | \
          tr -d '\n\r')

        if [[ -z "${YQ_VER}" ]]; then
           echo "Failed to extract yq version from toolchain.versions.yml" >&2
           exit 1
        fi

        echo "YQ_VERSION=${YQ_VER}" >> "$GITHUB_ENV"
        echo "Resolved yq version ${YQ_VER}"

    - name: Cache yq binary
      uses: actions/cache@v4
      with:
        path: ~/.local/bin/yq
        key: ${{ runner.os }}-yq-${{ hashFiles('toolchain.versions.yml') }}
        restore-keys: |
          ${{ runner.os }}-yq-
          yq-

    - name: Ensure yq is available
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        set -euo pipefail
        # Add tools/bin to PATH for this step AND subsequent steps
        # $GITHUB_PATH takes effect in NEXT step, so we also export locally
        echo "$PWD/tools/bin" >> "$GITHUB_PATH"
        export PATH="$PWD/tools/bin:$PATH"

        YQ_VER_TRIM="${YQ_VERSION#v}"

        # Ensure scripts are executable
        chmod +x scripts/tools/yq-pin.sh

        # Pinned Version erzwingen (Download + Verifikation)
        scripts/tools/yq-pin.sh ensure

        # Re-export PATH to ensure tools/bin is prioritized after yq-pin.sh runs
        export PATH="$PWD/tools/bin:$PATH"

        # Final verification - check both in PATH and at explicit location
        if [[ -x "$PWD/tools/bin/yq" ]]; then
          YQ_BIN="$PWD/tools/bin/yq"
        elif command -v yq >/dev/null; then
          YQ_BIN="$(command -v yq)"
        else
          echo "yq installation failed: binary not found at $PWD/tools/bin/yq and not in PATH" >&2
          exit 1
        fi

        YQ_VERSION_OUTPUT="$("${YQ_BIN}" --version)"
        echo "${YQ_VERSION_OUTPUT}"
        if ! echo "${YQ_VERSION_OUTPUT}" | grep -q "version v${YQ_VER_TRIM}"; then
          echo "yq version check failed. Expected v${YQ_VER_TRIM}, got: ${YQ_VERSION_OUTPUT}" >&2
          exit 1
        fi

        echo "âœ… yq ${YQ_VER_TRIM} verified OK at ${YQ_BIN}"
