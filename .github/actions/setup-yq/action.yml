---
name: 'Setup yq'
description: 'Install yq using version from toolchain.versions.yml (bootstraps if needed) and verify checksum'
inputs:
  github-token:
    description: 'GitHub token for API authentication (to avoid rate limits)'
    required: false
    default: ''
runs:
  using: 'composite'
  steps:
    - name: Load yq version pin
      shell: bash
      run: |
        set -Eeuo pipefail
        PS4='+(${BASH_SOURCE##*/}:${LINENO}): '
        
        on_fail() {
          code=$?
          echo "::group::FAIL DIAGNOSTICS (Load yq version)" >&2
          echo "exit_code=${code}" >&2
          echo "pwd=$(pwd)" >&2
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE:-<not set>}" >&2
          echo "::endgroup::" >&2
          exit "${code}"
        }
        trap on_fail ERR
        
        # Determine repo root - composite actions run in caller's workspace
        REPO_ROOT="${GITHUB_WORKSPACE:-.}"
        TOOLCHAIN_FILE="${REPO_ROOT}/toolchain.versions.yml"
        
        # Debug: check file existence
        echo "Checking ${TOOLCHAIN_FILE}..." >&2
        if [[ ! -f "${TOOLCHAIN_FILE}" ]]; then
             echo "::error::File not found: ${TOOLCHAIN_FILE}"
             ls -la "${REPO_ROOT}"
             exit 1
        fi

        # ---------------------------------------------------------------------
        # BOOTSTRAP YQ
        # YAML wird ausschließlich mit yq gelesen. Regex-Parsing ist verboten.
        # Wenn yq nicht im System ist, laden wir eine Bootstrap-Version.
        # ---------------------------------------------------------------------
        if ! command -v yq >/dev/null 2>&1; then
             echo "yq not found. Bootstrapping temporary yq for config parsing..." >&2
             BS_VER="v4.49.2"
             BS_OS=$(uname -s | tr '[:upper:]' '[:lower:]')
             BS_ARCH=$(uname -m)
             case "${BS_ARCH}" in
               x86_64) BS_ARCH="amd64" ;;
               aarch64) BS_ARCH="arm64" ;;
               arm64) BS_ARCH="arm64" ;;
               *) echo "::error::Unsupported architecture for bootstrap: ${BS_ARCH}"; exit 1 ;;
             esac

             # Fallback for OS
             case "${BS_OS}" in
               linux|darwin) ;;
               *) echo "::error::Unsupported OS for bootstrap: ${BS_OS}"; exit 1 ;;
             esac

             BS_URL="https://github.com/mikefarah/yq/releases/download/${BS_VER}/yq_${BS_OS}_${BS_ARCH}"

             # Install into tools/bin (standard location)
             mkdir -p "${REPO_ROOT}/tools/bin"
             echo "Downloading bootstrap yq from ${BS_URL}..." >&2
             if ! curl -fsSL "${BS_URL}" -o "${REPO_ROOT}/tools/bin/yq"; then
                  echo "::error::Failed to download yq from ${BS_URL}"
                  exit 1
             fi
             chmod +x "${REPO_ROOT}/tools/bin/yq"
             
             # Verify binary is executable after download
             if [[ ! -x "${REPO_ROOT}/tools/bin/yq" ]]; then
                  echo "::error::yq binary nicht ausführbar"
                  ls -la "${REPO_ROOT}/tools/bin/yq" >&2 || echo "Binary not found" >&2
                  exit 1
             fi

             # Add to PATH for this step and subsequent steps
             echo "${REPO_ROOT}/tools/bin" >> "$GITHUB_PATH"
             export PATH="${REPO_ROOT}/tools/bin:$PATH"
        fi
        
        # Verify we have yq now
        if ! command -v yq >/dev/null 2>&1; then
             echo "::error::yq bootstrap failed. yq command not found."
             exit 1
        fi

        # ---------------------------------------------------------------------
        # PARSE VERSION
        # ---------------------------------------------------------------------
        YQ_VER=$(yq eval '.yq' "${TOOLCHAIN_FILE}")

        # Ensure we got a valid string (not null)
        test -n "${YQ_VER}" || { echo "::error::yq version missing in toolchain.versions.yml"; exit 1; }
        if [[ "${YQ_VER}" == "null" ]]; then
           echo "::error::yq key is null in toolchain.versions.yml"
           exit 1
        fi

        echo "Resolved yq version: ${YQ_VER}" >&2
        echo "YQ_VERSION=${YQ_VER}" >> "$GITHUB_ENV"

        # ---------------------------------------------------------------------
        # REGRESSION CHECK (Mini-Teststep)
        # Ensure critical keys are present to prevent downstream failures
        # ---------------------------------------------------------------------
        echo "Verifying toolchain.versions.yml integrity..." >&2
        yq eval -e '.yq, .rust, .python, .uv, .just, .sccache, .actionlint' "${TOOLCHAIN_FILE}" >/dev/null

    - name: Cache yq binary
      uses: actions/cache@v4
      with:
        path: ~/.local/bin/yq
        # Use GITHUB_WORKSPACE to ensure consistent path resolution across composite action calls
        key: ${{ runner.os }}-yq-${{ hashFiles(format('{0}/toolchain.versions.yml', github.workspace)) }}
        restore-keys: |
          ${{ runner.os }}-yq-
          yq-

    - name: Ensure yq is available
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        set -Eeuo pipefail
        PS4='+(${BASH_SOURCE##*/}:${LINENO}): '
        
        on_fail() {
          code=$?
          echo "::group::FAIL DIAGNOSTICS (Ensure yq)" >&2
          echo "exit_code=${code}" >&2
          echo "pwd=$(pwd)" >&2
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE:-<not set>}" >&2
          echo "PATH=${PATH}" >&2
          echo "tools/bin contents:" >&2
          ls -la "${REPO_ROOT}/tools/bin" 2>/dev/null || echo "tools/bin not found" >&2
          echo "::endgroup::" >&2
          exit "${code}"
        }
        trap on_fail ERR
        
        # Determine repo root - composite actions might run in different contexts
        REPO_ROOT="${GITHUB_WORKSPACE:-.}"
        cd "${REPO_ROOT}"
        
        # Add tools/bin to PATH for this step AND subsequent steps
        # $GITHUB_PATH takes effect in NEXT step, so we also export locally
        # Note: If bootstrap ran, this might be duplicate, but harmless
        echo "${REPO_ROOT}/tools/bin" >> "$GITHUB_PATH"
        export PATH="${REPO_ROOT}/tools/bin:$PATH"

        YQ_VER_TRIM="${YQ_VERSION#v}"

        # Ensure scripts are executable
        chmod +x "${REPO_ROOT}/scripts/tools/yq-pin.sh"

        # Pinned Version erzwingen (Download + Verifikation)
        # The script uses BASH_SOURCE to find ROOT_DIR, so it will work from any location
        # This will verify the bootstrapped yq or download the correct version if different
        "${REPO_ROOT}/scripts/tools/yq-pin.sh" ensure

        # Re-export PATH to ensure tools/bin is prioritized after yq-pin.sh runs
        export PATH="${REPO_ROOT}/tools/bin:$PATH"

        # Final verification - check both in PATH and at explicit location
        if [[ -x "${REPO_ROOT}/tools/bin/yq" ]]; then
          YQ_BIN="${REPO_ROOT}/tools/bin/yq"
        elif command -v yq >/dev/null; then
          YQ_BIN="$(command -v yq)"
        else
          echo "yq installation failed: binary not found at ${REPO_ROOT}/tools/bin/yq and not in PATH" >&2
          exit 1
        fi

        YQ_VERSION_OUTPUT="$("${YQ_BIN}" --version)"
        echo "${YQ_VERSION_OUTPUT}"
        if ! echo "${YQ_VERSION_OUTPUT}" | grep -q "version v${YQ_VER_TRIM}"; then
          echo "yq version check failed. Expected v${YQ_VER_TRIM}, got: ${YQ_VERSION_OUTPUT}" >&2
          exit 1
        fi

        echo "✅ yq ${YQ_VER_TRIM} verified OK at ${YQ_BIN}"
